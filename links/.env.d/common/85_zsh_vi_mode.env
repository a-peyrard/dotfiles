# zsh-vi-mode plugin configuration
# Must load BEFORE fzf-tab (90) and syntax-highlighting (99)

ZVM_DIR="$HOME/.zsh/plugins/zsh-vi-mode"

# Skip if not installed
[[ ! -f "$ZVM_DIR/zsh-vi-mode.plugin.zsh" ]] && return

# Configuration (set before sourcing)
ZVM_VI_INSERT_ESCAPE_BINDKEY=jk
ZVM_LINE_INIT_MODE=$ZVM_MODE_INSERT
ZVM_CURSOR_STYLE_ENABLED=true

# Hook to restore bindings after zvm initializes
function zvm_after_init() {
    # Re-enable fzf if installed
    [[ -f ~/.fzf.zsh ]] && source ~/.fzf.zsh

    # Restore emacs-style bindings in insert mode
    bindkey -M viins '^A' beginning-of-line
    bindkey -M viins '^E' end-of-line
    bindkey -M viins '^K' kill-line
    bindkey -M viins '^U' backward-kill-line
    bindkey -M viins '^W' backward-kill-word
    bindkey -M viins '^R' fzf-history-widget 2>/dev/null || bindkey -M viins '^R' history-incremental-search-backward
    bindkey -M viins '^P' up-line-or-history
    bindkey -M viins '^N' down-line-or-history
}

# Hook to restore history prefix search in normal mode
function zvm_after_lazy_keybindings() {
    # History prefix search with j/k in normal mode
    autoload -U up-line-or-beginning-search down-line-or-beginning-search
    zle -N up-line-or-beginning-search
    zle -N down-line-or-beginning-search

    bindkey -M vicmd 'k' up-line-or-beginning-search
    bindkey -M vicmd 'j' down-line-or-beginning-search
}

# Source the plugin
source "$ZVM_DIR/zsh-vi-mode.plugin.zsh"
